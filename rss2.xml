<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Zhihao&#39;s Notes</title>
    <link>https://blog.zhihaoz.me/</link>
    
    <atom:link href="https://blog.zhihaoz.me/rss2.xml" rel="self" type="application/rss+xml"/>
    
    <description>取乎其上,得乎其中</description>
    <pubDate>Sat, 15 Mar 2025 07:36:58 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>如何在Overleaf中使用latexdiff</title>
      <link>https://blog.zhihaoz.me/2025/03/15/latexdiff/</link>
      <guid>https://blog.zhihaoz.me/2025/03/15/latexdiff/</guid>
      <pubDate>Sat, 15 Mar 2025 06:53:19 GMT</pubDate>
      
      <description>&lt;p&gt;……&lt;/p&gt;</description>
      
      
      
      <content:encoded><![CDATA[<p>……</p><span id="more"></span><p>latexdiff可视化地显示两个文件（版本）之间的显著差异。我想通过在overleaf中使用latexdiff，输出两个不同的PDF文件，一个PDF文件只显示原文，另外一个PDF文件显示两个版本之间的差异。</p><p>目前在main文件夹下，有<code>main.tex</code>（当前版本）和<code>main-old.tex</code>（旧版本）文件，同时包含<code>old</code>和<code>figs</code>子文件夹，如下图所示。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315152425325.png"></p><p><code>main.tex</code>通过<code>\input&#123;1-Abstract&#125;</code>等命令将当前版本的文件包括进来，当前版本的<code>1-Abstract.tex</code>等文件放在<code>main/</code>中。</p><p><code>main-old.tex</code>通过<code>\input&#123;old/1-Abstract&#125;</code>等命令将旧版本的文件包括进来，旧版本的<code>1-Abstract.tex</code>等文件放在<code>main/old/</code>中。</p><p>有两种方法可以用来生成“差异可视化PDF文件”。</p><h1 id="latexmkrc"><a href="#latexmkrc" class="headerlink" title="latexmkrc"></a>latexmkrc</h1><p>第一种方法是使用<code>latexmkrc</code>，即在<code>main/</code>下面创建一个<code>latexmkrc</code>文件，并将下列内容放进去：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$pdflatex = &quot;latexdiff main-old.tex main.tex --flatten &gt; main-d.tex; pdflatex %O  main-d&quot;</span><br></pre></td></tr></table></figure><p>其中<code>--flatten</code>参数将<code>\input</code>展开。此时不管是编译<code>main.tex</code>还是<code>main-old.tex</code>文件，都能得到“差异可视化PDF文件”。</p><p>如果想得到原文件，则要将<code>latexmkrc</code>文件里面的命令注释掉：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># $pdflatex = &quot;latexdiff main-old.tex main.tex --flatten &gt; main-d.tex; pdflatex %O  main-d&quot;</span><br></pre></td></tr></table></figure><p>这时编译<code>main.tex</code>得到的是当前版本的PDF文件，编译<code>main-old.tex</code>得到的是旧版本的PDF文件。</p><p>这种方法不方便的地方在于需要手动注释&#x2F;消除注释掉<code>latexmkrc</code>中的命令。</p><h1 id="diff-tex"><a href="#diff-tex" class="headerlink" title="diff.tex"></a>diff.tex</h1><p>第二种方法是使用一个单独的<code>diff.tex</code>文件（放在<code>main/</code>下），并将下列内容放进去：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\RequirePackage&#123;shellesc&#125;</span><br><span class="line">\ShellEscape&#123;latexdiff main-old.tex main.tex --flatten &gt; main-d.tex&#125;</span><br><span class="line">\input&#123;main-d&#125;</span><br></pre></td></tr></table></figure><p>此时编译<code>main.tex</code>得到的是当前版本的PDF文件，编译<code>diff.tex</code>得到的是“差异可视化PDF文件”，不需要手动注释&#x2F;消除注释。</p><p>下图为“差异可视化PDF文件”的某部分，其中红色是旧版本中的内容，蓝色是当前版本的内容。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315152707712.png"></p>]]></content:encoded>
      
      
      
      <category domain="https://blog.zhihaoz.me/tags/latex/">latex</category>
      
      
      <comments>https://blog.zhihaoz.me/2025/03/15/latexdiff/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>读书笔记-史记（四）</title>
      <link>https://blog.zhihaoz.me/2025/03/13/shiji-4/</link>
      <guid>https://blog.zhihaoz.me/2025/03/13/shiji-4/</guid>
      <pubDate>Wed, 12 Mar 2025 16:43:07 GMT</pubDate>
      
      <description>&lt;p&gt;一片汪洋都不见，知向谁边？&lt;/p&gt;</description>
      
      
      
      <content:encoded><![CDATA[<p>一片汪洋都不见，知向谁边？</p><span id="more"></span><h1 id="殷本纪"><a href="#殷本纪" class="headerlink" title="殷本纪"></a>殷本纪</h1><p>本纪第三为《殷本纪》。2000年发表的《夏商周年表》与《殷本纪》所谱列的顺序相同，商朝的统治年限为前1600一前1046，共历时554年。</p><p>商朝的始祖是殷契（xiè, “契始封商，其后裔盘庚迁殷，殷在邺南，遂为天下号。契是殷家始祖，故言‘殷契’。殷，地名，即今所谓“殷墟”，在今河南安阳西北小屯村一带。”），母亲是简狄，为帝喾次妃。天命玄鸟（燕子），降而生商。契长大后，辅佐大禹治水（据《夏本纪》，和禹一同治水的是“益”与“后稷”）。在帝舜时期担任司徒（古代三公之一，主管民政）。契被封在商地，赐姓子氏。契所在的氏族在尧、舜、禹期间发展起来。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250313004842124.png"></p><p>从契至汤（成汤，又名天乙）历经十四代，并经过八次迁都。汤建都在毫邑（今河南省商丘附近）。成汤说：“我说过，人从水中可以照见自己的容貌，从众人的反应中可以得知政治是否清明。”</p><p>伊尹说：“这话说得很好，能听取百官的意见，帝王的管理水平才能提高。要治好国家，管好黎民，就得让能办事的人都各在其位。努力呀，努力呀！”</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250313010004269.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250313010510596.png"></p><p>伊尹又称阿衡（一说是官名），早年微贱，他想见成汤却找不到机缘，于是就做了有莘氏的陪嫁奴仆，背着烹调用具，用做莱的道理比喻治国之道以说服成汤，协助成汤实现了王道的政治。汤破格重用伊尹，委伊尹以国政。伊尹曾一度离开商汤去了夏都，但他不满意夏桀的腐败，又回到商的国都。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250313235820134.png"></p><p>成汤的小故事一则。说有一天，成汤外出打猎，看到猎人围绕着猎场四周布网，猎人祈祷说：“愿天下四方的鸟兽都落入我的网中。”成汤说：“唉，这不是要把它们一网打尽了吗？”于是他下令撤去三面的网，并将祷告词改为：“想从左边走的，往左；想从右边走的，往右；不听从指挥的，才落入我的罗网。”诸侯们得知后，说：“成汤的仁德真是无以复加了，连禽兽都能蒙受他的恩泽。”</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314000523422.png"></p><p>夏桀施行暴政，荒淫无道，诸侯中的昆吾氏（一说在今河南许昌东）也为非作歹。成汤于是率诸侯讨伐昆吾氏，伊尹随汤出征。成汤击败昆吾氏后，乘胜讨伐夏桀，并作了《汤誓》通告全军。</p><p>人们非常恨夏桀，夏桀自比<strong>太阳</strong>，所以人们说：“<strong>时日曷（hé）丧，予与汝皆亡</strong>”。这句话的意思是“你这太阳何时消亡，我情愿与你同归于尽”。</p><p>成汤说“我很勇武”，于是自己号称为武王。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314000701170.png"></p><p>夏桀被打败，逃到了鸣条（今河南封丘东），夏朝的军队被彻底消灭，夏朝从此灭亡。</p><p>成汤战胜夏桀后，想改换夏朝所祭祀的土神（一说为共工之子句龙，治水有功），但是改换不了，因而作了《夏社》。</p><p>伊尹向各地诸侯发出通告，各地诸侯都表示归附商朝，于是成汤践天子位，平定海内。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314005455508.png"></p><p>成汤灭了夏朝后，回到毫都，遂作《汤诰》以告谕天下。让各地诸侯与各国君主必须多给黎民百姓作贡献，勤勤恳恳地做好自己的工作，并从禹、皋陶、后稷与蚩尤的正反两面中吸取救训。</p><p>成汤实行新历法，改正朔即改用新历法。正朔是一年中第一个月的第一天。夏朝是以阴历正月（建寅月）为岁首，商朝是以阴历十二月（建丑月） 为岁首，周朝是以阴历十一月（建子月）为岁首，秦朝是以阴历十月（建亥月）为岁首。</p><p>又变换服饰，崇尚白色。夏尚黑，商尚白，周尚赤。群臣朝见帝王商议国事也定在白天。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314010310290.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314010324586.png"></p><p>成汤去世后，汤的儿子太丁、外丙、中壬继位。之后伊尹让太丁之子成汤的嫡长孙太甲继位。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314011044844.png"></p><p>帝太甲在位三年，昏庸暴虐，不遵守成汤定下的制度，德行丑恶，伊尹便把他放逐到桐宫（一说在今河南偃师附近）。</p><p>这期间，伊尹摄政代替太甲治理国事，接受诸侯的朝见。太甲在桐宫住了三年，他悔过自省，改恶从善，伊尹便将他接了回来，把政权交还给他。</p><p>太甲经过修炼提高了道德，诸侯对他表示归附，百姓的生活也都很安宁。</p><p>为嘉奖太甲的错而能改，伊尹作了《太甲训》两篇，并且褒扬太甲，称他为“太宗”。古代开国帝王之庙号可称为“高祖”或“太 祖”，其继世帝王有圣德著于世者可称为“太宗”。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314011356155.png"></p><p>沃丁为帝时，伊尹去世，葬在了毫都。到帝雍己时，商朝的国力渐弱，有的诸侯已经不来朝拜。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314011743427.png"></p><p>到帝太戊时，任用贤臣伊陟为相。一说伊陟为伊尹之子，一说汤到太戊有七世，而伊尹的儿子伊陟才担任相，他们的寿命差距如此悬殊。</p><p>伊陟劝太戊修德，并重用贤臣。殷朝重新兴旺，诸侯都来归顺，为此，称太戊为“中宗”。使国家中兴之君，庙号可称“中宗”。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250314012054782.png"></p><p>盘庚即位之前，殷朝建都在黄河以北。盘庚即位后率众迁到了黄河以南，重又回到了成汤时的故都毫邑（今河南偃师商城或郑州商城）。《竹书纪年》说盘庚是由黄河东南的奄（今山东曲阜）迁往黄河以北的殷墟（今河南安阳西北小屯村）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315005316536.png"></p><p>武丁继位三年之内不动声色，把政务交给太宰。武丁夜里梦见一位名叫“说”的能人，然后在傅险（今山西平陆东）这个地方找到了。当时那个叫“说”的人是个苦役犯，正在傅险修路。武丁破格任用他为宰相，殷朝被他治理得很有起色。于是武丁就将傅险作为他的姓氏，称他为傅说（傅说举于版筑之间）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315005809382.png"></p><p>帝武乙做了个木偶，说它是天神，武乙要和这个“天神”较量，他让人替“天神”投掷，“天神”输了，于是武乙就侮辱 他。武乙用皮革做了一条口袋，里面装满了血，他把这个口袋挂得高高的，从下面往上射，说这是“射天”。</p><p>武乙到黄河与渭水汇合的地方打猎，遇着打雷，被击死了。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315010658195.png"></p><p>帝乙的长子是微子启。小儿子叫辛，辛的母亲是王后，所以帝乙死后，其子辛继位，这就是帝辛（又称受），天下称之为纣。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315010924551.png"></p><p>帝纣天资聪敏，反应快，力气超常，能空手与猛兽格斗😢。</p><p>知（智）足以距（拒）谏，言足以饰非。即帝纣的才智足以使他挡回任何劝谏，他的能言善辩足以帮他文过饰非。</p><p>帝纣喜欢在群臣面前夸示自己的才干，希望让自己的名声高过普天下的任何人，他认为天底下没有一个人能与他相比。</p><p>帝纣喜欢饮酒作乐，贪恋女色。他宠爱妲己（有苏氏），唯妲己之言是听。他让乐工师涓谱制淫荡的曲子，他用北方的淫靡之舞配合这种靡靡之乐。</p><p>帝纣横征暴敛以填满鹿台（今河南淇县）的线库和巨桥的粮仑。他扩建沙丘（今河北平乡东北，战国时属赵，赵武灵王饿死于此，后秦始皇东巡又死于此）的亭台园圃，搜罗各种珍禽异兽置于其中。</p><p>帝纣从来不敬神。他把许多乐工戏子叫到沙丘来，他用酒灌成池沼，把肉悬挂成林，让男男女女光着身子在里面追逐嬉戏，彻夜不息（酒池肉林）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250315011140481.png"></p>]]></content:encoded>
      
      
      <category domain="https://blog.zhihaoz.me/categories/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8E%86%E5%8F%B2/">历史</category>
      
      
      <comments>https://blog.zhihaoz.me/2025/03/13/shiji-4/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>读书笔记-史记（三）</title>
      <link>https://blog.zhihaoz.me/2025/03/07/shiji-3/</link>
      <guid>https://blog.zhihaoz.me/2025/03/07/shiji-3/</guid>
      <pubDate>Thu, 06 Mar 2025 16:03:27 GMT</pubDate>
      
      <description>&lt;p&gt;大雨落幽燕，白浪滔天，秦皇岛外打渔船。&lt;/p&gt;
&lt;!-- 有多少风流人物？盗跖庄蹻流誉后，更陈王奋起挥黄钺。 --&gt;</description>
      
      
      
      <content:encoded><![CDATA[<p>大雨落幽燕，白浪滔天，秦皇岛外打渔船。</p><!-- 有多少风流人物？盗跖庄蹻流誉后，更陈王奋起挥黄钺。 --><span id="more"></span><h1 id="夏本纪"><a href="#夏本纪" class="headerlink" title="夏本纪"></a>夏本纪</h1><p>本纪第二为《夏本纪》。“过去人们把夏王朝的历史通通归于“传说”范畴，甚至连大禹有无其人也有人持怀疑态度。近些年来随着商朝考古的巨大进展，尤其是 “夏商周工程”的启动，事实已经证明《殷本纪》所记的商朝世系是符合科学实际的。既然商朝的世系符合实际，那么夏朝的情况又当如何呢？在“夏商周工程”所发表的阶段报告中，已经肯定了《夏本纪》所列的夏朝世系，并将夏王朝存在的年代确定在公元前2070至前1600。—摘自韩版”</p><p>禹是黄帝的玄孙，夏是帝禹的国号，禹的父亲是鲧（一说鲧封于崇，称崇伯鲧），鲧的父亲是帝颛顼，禹是帝颛顼的孙子，而上章说到舜是帝颛顼的六世孙，按辈分，禹应为舜的高祖辈😓。</p><p>有注释说“他们俩能相见已属难得，且禹的年龄理应远大于舜。然而，当舜命禹治水时，禹才刚娶涂山之女，之后又接受舜的禅让，在位十七年后崩于会稽。由此推断，禹的年龄实则小于舜，这岂合常理！”</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307001129337.png"></p><p>这一段的大部分内容都在五帝本纪里提到过。舜在巡视过程中发现鲧治理洪水没有功绩，就在羽山将鲧处死。天下人都认为舜惩罚鲧是正确的。于是舜推举鲧的儿子禹，命他继续鲧的事业。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307002224853.png"></p><p>舜命禹为司空，治理水土。禹于是就与益、后稷尊奉帝舜的命令，确定高山大川的治理规划。禹在外面治水十三年，经过家门都不敢进去。禹准绳规矩不离手，不违背四时节气，开划九州土地，疏通九条水道，修筑九处湖泽堤障，测量九大山系。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307002803755.png"></p><p>下图为禹贡所划分的九州（来源：张版）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307003522999.png"></p><p>禹继承舜，面南而坐，接受天下臣民的朝拜，国号定为夏后，姓氏为姒。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307003906352.png"></p><p>帝禹继位后，便推举皋陶为继承人，然而皋陶未及登基便不幸辞世。继而，帝禹又举荐了益，委以他管理政务的重任。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307231558784.png"></p><p>帝禹在位第十年东巡，逝于会稽。临终前传位给益，但益谦让，隐居箕山南麓。禹之子启贤明，深得民心。禹虽传位益，因益辅政时日尚短，未获天下信任。诸侯纷纷转向启，称：“此乃吾君禹帝之子也。”启遂继位，是为夏后帝启。启为禹与涂山氏之女所生。</p><p>注释一说“尧、舜、禹之禅让，出于儒家的艳谈，古本《竹书纪年》则曰“益干启位，启杀之”，无彼此揖让之事”。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307231835485.png"></p><p>有扈氏就不服了，一说“扈为夏同姓之国。有扈见尧、舜受禅，启独继父，故不服”。又有一说“有扈为启之兄弟”，“有扈，启之庶兄，以尧、舜举贤，禹独与子，故伐启”。</p><p>启与有扈氏大战于甘（今洛阳市西南），启作了一篇誓词《甘誓》，召来六军的将领申明这一誓词。然后灭了有扈氏，天下咸朝。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307232531057.png"></p><p>夏后帝启驾崩，儿子太康继位，太康因为耽于游乐而失去国位（一说为被有扈氏之后“羿”所灭）。太康之后弟弟中康继位。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307233434587.png"></p><p>随后简要记载了夏朝的帝王世系。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307234037522.png"></p><p>至夏桀（履癸）时，自孔甲以来诸侯多已叛离。桀不思修德振国，反以武力压迫百官，致朝野怨声载道。桀曾囚（商）汤于夏台（今河南禹州），后将其释放。汤修德政，诸侯归心，遂起兵伐桀。桀败走鸣条（一说在今河南封丘东，也有一说在今山西运城安邑镇北），终死于逃亡途中。临终悔道：”早知今日，当在夏台诛汤。”汤继位，建立商朝，分封夏后裔，到周朝时夏后裔被封在杞国（今河南杞县）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307234241378.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307234258135.png"></p><p>《夏本纪》最后，太史公也写了说明和议论，这里贴上全部译文。</p><p>太史公说：禹姓姒，他的后代分封，就以所分封的国为姓，所以有夏后氏、有扈氏、有男氏、斟寻氏、彤城氏、褒氏、费氏、杞氏、缯氏、辛氏、冥氏、斟戈氏等不同的姓氏。孔子校正夏代的历法，所以学者中有很多人传授《夏小正》。从虞、夏时期开始，贡纳赋税的制度就已经很完备了。<br>有人说禹在江南召集诸侯，考核诸侯功绩时去世，因此就安葬在那里，将该地命名为会稽。会稽，意即会计，就是会集诸候核计其功绩的意思。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250307234749733.png"></p>]]></content:encoded>
      
      
      <category domain="https://blog.zhihaoz.me/categories/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8E%86%E5%8F%B2/">历史</category>
      
      
      <comments>https://blog.zhihaoz.me/2025/03/07/shiji-3/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>读书笔记-史记（二）</title>
      <link>https://blog.zhihaoz.me/2025/03/05/shiji-2/</link>
      <guid>https://blog.zhihaoz.me/2025/03/05/shiji-2/</guid>
      <pubDate>Wed, 05 Mar 2025 15:41:15 GMT</pubDate>
      
      <description>&lt;p&gt;五帝三皇神圣事，骗了无涯过客。&lt;/p&gt;</description>
      
      
      
      <content:encoded><![CDATA[<p>五帝三皇神圣事，骗了无涯过客。</p><span id="more"></span><p>上一章记录了黄帝、帝颛顼、帝喾和帝尧时期的事迹，这一章从帝舜开始。</p><h1 id="帝舜"><a href="#帝舜" class="headerlink" title="帝舜"></a>帝舜</h1><p>根据传说，舜天生异相，生有重瞳，因此被称为“重华”。他是上虞人，也被尊称为虞舜。从家世来看，舜是昌意的七世孙，而昌意是黄帝的儿子，这意味着舜是黄帝的八世孙。帝尧是帝喾的儿子，而帝喾是黄帝另一个儿子玄嚣的孙子，帝尧只是黄帝的三世孙。两人的辈分似乎存在一些矛盾😢😳。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305234822072.png"></p><p>之后介绍舜的家世，舜父是盲人，母亲去世之后舜父又娶了一个，然后生了个儿子叫象，象为人傲慢，但舜父很宠爱，常想杀舜，舜则总是躲着他。如果惩罚不重时，也就委屈地忍受了。他顺从地待候着父亲、后母和弟弟，每天谦恭谨慎，从不怠慢。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305235735332.png"></p><p>舜是冀州人，居蒲阪城（在今山西永济市蒲州镇，古属冀州），曾在历山（又名雷首山，在今山西永济市境内）种田，在雷泽捕鱼，在黄河边上制作陶器，在寿丘（今山东）制造各种生产生活用品，还在负夏（今山东）从事过商业活动。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306000204693.png"></p><p>帝尧为考察舜，将两位女儿嫁给他以观其治家之道，又让九个儿子与他交往以察其处世之能。舜在妫汭的家中严谨持家，两位公主不敢怠慢，恪守妇道；九位王子也受其影响，日渐稳重。</p><p>舜的德行感化四方：在历山耕作，化解了地界之争；在雷泽捕鱼，促进了渔民和睦；在河边制陶，提升了陶器质量。他所居之处，一年成村落，两年变市镇，三年化都城。</p><p>尧赏识舜的才能，赐予衣物、琴具，并为其修建粮仓、赠送牛羊。然而舜的父亲瞽叟仍存加害之心，两次设计谋害舜，都被舜机智化解（一说这些事为后人杜撰）。面对父亲与弟弟的恶意，舜始终以德报怨，保持孝悌之心。</p><p>最终，尧让舜制定五典、教化百姓、管理百官，舜皆出色完成，展现出了非凡的治国才能。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306000822492.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306000832758.png"></p><p>当时有四凶，浑沌（一说是讙兜）、穷奇（一说是共工）、梼杌(táo wù，一说是鲧)、饕餮(tāo tiè，一说是三苗)。舜为广纳贤才，决定敞开国都四门。为此，他将四凶驱逐至远方，令其抵御妖魔。自此，国都四门常开，国内再无作恶之人。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306001436464.png"></p><p>这里有一段注释，“北宋孙明复说尧并不是不能铲除这四凶，只是要把他们留给舜，让舜的功绩显著于天下。这段太史公为突出舜，无形之中降低了尧，孙氏又巧为尧说解，可谓用心良苦”😅。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306003258778.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306003314734.png"></p><p>舜继位之后，任用禹、皋陶（gāo yáo, 舜时掌刑狱的官）、契（舜时掌教化的官，商朝的祖先）、后稷（也称弃，舜时掌管农事的官，周朝的祖先）、伯夷（舜时掌礼的官，周初齐太公之祖先）、夔、龙、倕、益（也称“伯益”、“伯翳”、“大业”，秦国的祖先）、彭祖等人。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306233023858.png"></p><p>下图为五帝的都城（来源：张版），基本都在今山河四省。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306234422376.png"></p><p>这里概述了帝舜的一生，在帝位三十九年，前往南方巡视，最终在苍梧郡的郊野逝世，安葬于长江以南的九疑山，即后来的零陵郡。</p><p>舜的儿子商均不成器，舜便提前将禹推荐给上天。十七年后，舜驾崩，三年丧期结束后，禹仿效舜将帝位让给尧的儿子的做法，也将帝位让给舜的儿子，但诸侯们都归心于禹，于是禹最终登基为天子。尧的儿子丹朱和舜的儿子商均都享有封地，以祭祀他们的先祖。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306234629587.png"></p><p>这里说明了五帝都源自同一个姓氏，但是国号不同。帝禹的国号是夏后，后来帝禹又改称为姒氏。契的国号是商，姓子氏。弃的国号是周，姓姬氏（先秦时期姓和氏是不同的，但是在这里太史公混淆了）。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306235109973.png"></p><p>《五帝本纪》最后，太史公写了说明和议论，这里贴上全部译文。</p><p>太史公说：有不少学者讲述过五帝之事，但五帝的时代久远，《尚书》也只是记载了尧以后的事情；各家学派讲述黄帝的事情不少，但内容荒诞不经，有身份有头脑的人是不会相信那些话的。孔门教学用过的《宰予问五帝德》和《帝系姓》，不是儒家的经典，不被某些儒者所承认。我曾向西到过空桐山，向北到过涿鹿，向东到过大海边，向南曾渡过淮河长江，在我所到的相关地区，都曾听到过当地长老讲述黄帝或是讲述尧、舜的事情，而这些不同地区的风土人情也的确不同，因此总的感觉还是古文典籍的说法比较接近事实。我读过《春秋》、《国语》，其中对《五帝德》、《帝系姓》中一些说法的阐发是很清楚的，问题只是人们没作深入的研究，其实这两本书所表述的观点还是比较切实可信的。《尚书》有很多散佚，到现在已经相当久远了，其所散佚的内容偶尔还能从其他著作中见到。如果不是好学深思，真正对古代传说有所理解，是很难对那些学识浅陋的人说清楚的。于是我选择较为确实可信的材料，编排阐发，写成了这“本纪”部分的第一篇。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306235721552.png"><br><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250306235734208.png"></p>]]></content:encoded>
      
      
      <category domain="https://blog.zhihaoz.me/categories/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8F%B2%E8%AE%B0/">史记</category>
      
      <category domain="https://blog.zhihaoz.me/tags/%E5%8E%86%E5%8F%B2/">历史</category>
      
      
      <comments>https://blog.zhihaoz.me/2025/03/05/shiji-2/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>FlacIO论文浅读</title>
      <link>https://blog.zhihaoz.me/2025/02/26/flacio/</link>
      <guid>https://blog.zhihaoz.me/2025/02/26/flacio/</guid>
      <pubDate>Wed, 26 Feb 2025 11:17:17 GMT</pubDate>
      
      <description>&lt;p&gt;……&lt;/p&gt;</description>
      
      
      
      <content:encoded><![CDATA[<p>……</p><span id="more"></span><p>FlacIO<a href="#FlacIO">[1]</a>是存储顶会FAST25的论文，研究方向是容器镜像加速。因为我最近在做一些云计算和虚拟化相关的研究工作，所以对这篇论文很感兴趣。这里记录一下我对这篇论文的理解、总结和思考。因本人水平有限，如有错误，欢迎指正。</p><h1 id="背景和相关知识"><a href="#背景和相关知识" class="headerlink" title="背景和相关知识"></a>背景和相关知识</h1><h2 id="容器镜像加速"><a href="#容器镜像加速" class="headerlink" title="容器镜像加速"></a>容器镜像加速</h2><p>容器使用较为广泛。容器镜像（container image）的存储栈，通常由远程镜像仓库（remote registry）负责镜像的存储与管理，以及主机节点上的存储驱动（storage driver）用于拉取（pull）镜像并挂载根文件系统（root file system）。</p><p>一个容器镜像由底部的多个只读层（read-only layer）和顶部的一个可写层（writable layer）构成。Storage driver一般使用OverlayFS来堆叠镜像文件，同时管理根文件系统。</p><p>容器冷启动（Cold startup）时需要从远程仓库拉取image并在主机节点上启动容器。容器启动时往往只需要使用镜像中的一小部分数据，因此full image loading会有较长的容器启动延迟，同时网络带宽利用率也较低。目前有两种优化方法。</p><p>首先是Cold Startup Acceleration，主流的优化方法是使用lazy loading来加速容器启动。Lazy loading先加载好镜像metadata，然后再按需加载（on-demand）容器启动时需要的镜像数据，需要哪块就pull &amp; load哪块。</p><p>比较知名且使用广泛的有CRFS<a href="#CRFS">[2]</a>和DADI<a href="#DADI">[3]</a>。CRFS基于FUSE（Filesystem in Userspace），是文件系统层的镜像加速方法，同时提供了stargz的镜像格式。DADI基于TCMU（iSCSI block device in Userspace），是块层的镜像加速方法，也提供了zfile镜像格式。</p><p>Lazy loading进行容器启动时，会频繁地触发I/O操作，并且阻塞镜像服务。现有的lazy loading方法使用预取（prefetching）来减轻这个过程的影响。</p><p>CRFS允许用户在镜像创建过程中将文件按照优先级排列以进行预取。DADI可以通过定制的虚拟块设备（virtual block device）记录块I/O trace，然后在容器启动时根据这些trace预取数据。</p><p>其次是Cold Startup Mitigation，例如Caching/Sharing，主要是hot/idel containers共享；例如定制和优化fork机制，基于其他进程快速启动容器；例如P2P Loading，从相邻的peer快速拉取镜像数据。</p><h2 id="Lazy-Loading"><a href="#Lazy-Loading" class="headerlink" title="Lazy Loading"></a>Lazy Loading</h2><p>下图展示了file-level和block-level lazy loading系统：</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250304161527259.png"></p><p>File-level lazy loading系统通常基于OverlayFS，其堆叠（stack）在本地文件系统之上，有四层：lower layer是镜像只读层和目录；upper layer是对只读层的修改；work layer短暂存储文件系统操作的中间状态；merge layer整合upper layer和lower layer，为容器提供文件系统的unified view。</p><p>容器对根文件系统的访问操作都被OverlayFS重定向到本地的文件系统。Page miss时，本地文件系统通知lazy loading module从registry上拉取镜像数据。</p><p>为了减少拉取开销，使用cache来预取和缓存将要使用的page。Block-level lazy loading系统的overlay特性和prefetch cache是基于block layer的。</p><p>Container cold startup分为三个阶段：</p><ol><li><p>Deploy阶段。从registry获得容器运行所需的数据和元数据。</p></li><li><p>Running阶段。主机创建容器runtime。</p></li><li><p>Ready阶段。主机启动容器并执行entrypoint。</p></li></ol><p>下面作者通过实验展示容器冷启动开销，启动Pytorch容器，然后使用<code>import torch</code>作为entrypoint。主机和registry分别在两个节点上，并通过TCP/IP网络连接。以下是测试结果：</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250304180406256.png"></p><p>主要有两个重要的实验观察：</p><ol><li><p>现有的lazy loading方案减少了Deploy阶段的延迟，但它们在Ready阶段的开销较高。这是因为lazy loading将I/O操作推迟到容器执行阶段，其核心收益在于大幅减少需要加载的数据，因此在冷启动时，对比full image loading减少了80%的延迟。FlacIO在确保其他阶段开销不变的情况下，进一步减少Ready阶段的开销。</p></li><li><p>I/O放大和网络访问是容器冷启动的主要性能瓶颈。Lazy loading的I/O放大依然较多，首先是因为这些系统大多是以file和chunk的粒度来loading镜像数据的，且容器启动时镜像数据的空间局部性不高；其次这些系统在Ready阶段有大量的远程数据随机访问，网络资源的利用率不高。I/O放大也会浪费网络带宽。</p></li></ol><p>但是这些开销和放大不容易解决，更小的按需加载粒度减少了I/O放大，但会有更多的网络包，增加了网络负载。</p><p>预取显然是一个可以解决I/O放大的方法，但是现有的预取方法没有高效地聚合I/O，预取也并不准确。</p><p>读到这里大致可以感觉到作者想对prefetch方法进行优化，可能是提出一个更有效的prefetch方法。</p><h1 id="动机和挑战"><a href="#动机和挑战" class="headerlink" title="动机和挑战"></a>动机和挑战</h1><p>传统的image abstraction是Global Oriented，即拥有运行镜像的所有文件和命名空间。但是每个container仅使用完整文件数据的一小部分，并且不同服务的containers使用的部分也不相同。</p><p>其次image abstraction是Storage Oriented，即记录了根文件系统的磁盘布局，因此，lazy loading需要从registry中获取数据，并在被容器使用之前重建本地内存状态（memory state）。</p><p>Image abstraction在容器冷启动时会有四个问题：</p><ol><li><p>I/O难以聚合，因为在容器启动过程中所需的数据是离散地分布在不同镜像文件中的不同位置。</p></li><li><p>I/O放大难以消除，因为镜像数据通常是压缩存储的，难以按page粒度进行索引。</p></li><li><p>很难在不同服务的容器之间优化I/O locality。</p></li><li><p>目前的Lazy loading需要复杂的I/O转发来加载数据，并构建根文件系统的内存状态。</p></li></ol><p>基于这些问题，FlacIO想要使得image abstraction是Memory Oriented，也就是需要记录容器的内存状态。然后还要是Service Oriented，一类服务需要一个镜像（服务容器的内存状态）。</p><p>因此FlacIO预先构建容器服务的根文件系统的内存状态（称为Runtime Image，RI）。RI有两个优点：</p><ol><li><p>首先，它只包含启动容器所需的最小数据集，并且有利于I/O聚合。</p></li><li><p>其次，它可以支持快速的根文件系统构建，因为它包含一个完整的内存状态。同时RT可以基于lazy loading系统，为根文件系统的构建提供一条快速路径。</p></li></ol><p>那之后就有两个挑战：</p><ol><li><p>首先是RT的组织形式。RT必须准确记录冷启动所需的最小元数据和数据集；而且必须紧凑，以免给后端镜像存储带来沉重负担；同时必须能够平滑/无障碍地嵌入主流容器运行时（例如Containerd），并且对上层系统和用户透明。</p></li><li><p>其次，RT对主机I/O栈的影响。当前内核不支持直接加载容器根文件系统的内存状态，需要新的操作系统原语和缓存机制；此外RT应该基于lazy loading，新的I/O栈需要与传统的on-demand loading I/O堆栈兼容。</p></li></ol><p><strong>个人思考</strong>：FlacIO对当前lazy loading系统在容器冷启动场景下的缺陷进行了深入分析，尤其是针对I/O放大和网络带宽利用率低等问题的剖析十分透彻。通过对其动机和挑战的阐述，可以清晰地认识到，确实需要一种能够记录容器启动时内存状态的解决方案来应对这些瓶颈。然而，如果这种方案需要依赖内核修改来实现，可能会带来一系列潜在问题，包括对系统性能的影响、稳定性的风险，以及在生产环境中的部署复杂度增加等。这些问题无疑会对方案的实际落地和推广构成不小的挑战。</p><h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><p>以下是FlacIO的架构图：</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250304235950838.png"></p><p>主要包括四个组件：</p><ol><li><p>FlacIO Driver，运行在container runtime里，主要是进行一些控制平面的操作。</p></li><li><p>I/O Tracker，运行在VFS（Virtual File System）里，在容器运行时记录I/O操作。</p></li><li><p>Runtime Page Cache（RTPC），基于OverlayFS实现，提供新的操作系统原语，允许容器使用RT有效地构建根文件系统。</p></li><li><p>Runtime Image Service，部署在registry里和FlacIO driver配合进行镜像管理。</p></li></ol><p>工作流程是这样的：</p><ol><li><p>用户为container service创建RT时，FlacIO driver通过传统的lazy loading方法启动容器，并记录其I/O行为，直到满足RT创建条件。</p></li><li><p>然后，将I/O日志发送给registry，以offline的方式生成相应的RT。</p></li><li><p>在容器的冷启动过程中，FlacIO driver检查目标RT是否在registry中。如果不存在，则使用传统的lazy loading方法启动容器。</p></li><li><p>如果目标RT存在，FlacIO driver通过incremental loading将其拉取到宿主机上，然后注入到RTPC中。容器就可以开始启动了。</p></li></ol><h2 id="Runtime-Image"><a href="#Runtime-Image" class="headerlink" title="Runtime Image"></a>Runtime Image</h2><p>RT主要有两个关键设计：准确收集容器的I/O行为的probe-based tracing机制；能够提高网络传输效率、减少存储开销以及和当前容器生态系统兼容的RT结构。</p><h3 id="Probe-based-Tracing"><a href="#Probe-based-Tracing" class="headerlink" title="Probe-based Tracing"></a>Probe-based Tracing</h3><p>该设计的核心原则是当probe捕获到相应的事件时停止I/O tracing。</p><p>Probes分为external probes和internal probes。External probes检测容器外部的容器状态，比如网口状态检测。</p><p>Internal probes在容器中运行，是一个entrypoint。在I/O tracing期间，FlacIO使用internal probes来运行容器。用户在创建RT时需要指定probes的类型和内容。</p><p>与DADI中的static tracing机制（手动设置持续时间）相比，基于probe的方法可以更准确、更灵活地收集容器启动所需的I/O。</p><p>File-level tracing可以适配不同的container平台。由于文件系统对I/O进行了reorchestration，block-level和容器I/O请求可能会有一定的差异。</p><p>I/O tracker基于eBPF设计，FlacIO在file read和page fault的入口处添加了eBPF probes，确保I/O请求被准确且完整地收集。</p><p>I/O tracker会生成I/O trace，其中包含多个triples，每个triple记录了I/O的文件路径、偏移量和大小。I/O traces之后被发送到registry，并异步地生成RT。</p><h3 id="RT组织和管理"><a href="#RT组织和管理" class="headerlink" title="RT组织和管理"></a>RT组织和管理</h3><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305005645347.png"></p><p>Group Metadata：一个base image可能对应多个services，相同base images生成的RT组合起来形成一个group，然后有一些元数据信息。</p><p>Service Metadata：每个RT包含它自己的元数据信息。</p><p>Group Data Zone：存放RT数据的连续存储空间，重删一个group内的pages。</p><p>RT生成是从Group Metadata开始，知道相应的page填入Group Data Zone。删除是从Group Data Zone开始，然后再删除相关元数据。</p><h2 id="Runtime-Page-Cache"><a href="#Runtime-Page-Cache" class="headerlink" title="Runtime Page Cache"></a>Runtime Page Cache</h2><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305010716526.png"></p><p>RTPC基本是和RT的结构对应的，将RT载入RTPC的过程基本上和传统page cache miss的过程差不多。</p><p>首先，使用rt_diff比较registry的service metadata和RTPC中的bitmap，找到没有载入RTPC的pages；然后从registry拉取，使用rt_inject载入RTPC。</p><p>RTPC通过hook OverlayFS的相应文件接口来实现，并且是一个只读的kernel cache，负责处理RT中文件和页面的open/read/mmap操作。对于不属于RT的文件和页面的访问，则由原始的VFS进程处理。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>RTPC和FlacIO driver是基于OverlayFS和Containerd实现的。</p><p>对主机内核的修改：I/O tracker是通过在容器启动（read、mmap和page fault）的I/O路径中添加eBPF probes来实现的。RTPC是在OverlayFS中实现的，通过sysfs为用户空间公开了rt_diff和rt_inject原语。此外，OverlayFS的部分文件操作被重定向到RTPC。</p><p>下面是FlacIO的流程，简单来说是在Deploy和Running阶段直接载入RT快速建立根文件系统。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305012259721.png"></p><h1 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h1><p>FlacIO的冷启动延迟比其他系统更低，热启动延迟差别不大。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305012601598.png"></p><p>Performace Breakdown显示FlacIO大幅减少了image loading的时间，同时I/O栈的开销也比较小。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305012747127.png"></p><p>FlacIO的设计组件分析，展示出RTPC对性能的改进最大。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305013015446.png"></p><p>FlacIO的RT有一些存储开销，不超过18%。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305013146257.png"></p><p>文件访问性能基本没有变化。</p><p><img data-src="https://zzh-blog-data.oss-cn-hangzhou.aliyuncs.com/img/20250305013247261.png"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>FlacIO追踪并记录容器启动时的I/O，然后在registry上将其转化为RT存储。当容器再次启动时，这些数据会被拉取并加载到 RTPC 中，从而加速启动过程。</p><p>FlacIO 对现有的 lazy loading 系统进行了全面分析，精准定位了其性能瓶颈，因此我在背景和动机部分做了较为详细的记录。相比之下，FlacIO 的设计思路和核心理念并不令人意外，所以对其设计细节仅做了简要概述。不过，FlacIO 的设计点非常清晰且全面，几乎涵盖了一个完整系统所需的全部细节。FlacIO 基于 openEuler 开发，未来可能会开源。</p><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a name="FlacIO"></a><br>[1] <a href="https://www.usenix.org/conference/fast25/presentation/liu-yubo">FlacIO: Flat and Collective I/O for Container Image Service</a>.<br><a name="CRFS"></a><br>[2] <a href="https://github.com/google/crfs">Google CRFS</a>.<br><a name="DADI"></a><br>[3] <a href="https://www.usenix.org/conference/atc20/presentation/li-huiba">DADI block-level image service for agile and elastic application deployment</a>.</p>]]></content:encoded>
      
      
      <category domain="https://blog.zhihaoz.me/categories/Paper/">Paper</category>
      
      
      <category domain="https://blog.zhihaoz.me/tags/Container/">Container</category>
      
      <category domain="https://blog.zhihaoz.me/tags/Paper/">Paper</category>
      
      
      <comments>https://blog.zhihaoz.me/2025/02/26/flacio/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
